# 鹦学伴 - 技术架构设计方案

## 一、整体系统架构

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层 (Client Layer)                          │
├──────────────┬──────────────┬──────────────────┬───────────────────────────┤
│   iOS App    │ Android App  │   微信小程序      │      微信公众号            │
│   (Swift)    │   (Kotlin)   │   (原生MINA)      │     (Vue3 H5)             │
└──────┬───────┴──────┬───────┴────────┬─────────┴─────────────┬─────────────┘
       │              │                │                       │
       └──────────────┴────────────────┴───────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            网关层 (Gateway Layer)                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │   API Gateway   │  │   负载均衡 SLB   │  │   WAF 防火墙 + 限流熔断      │  │
│  │   (Spring GW)   │  │   (Nginx)        │  │   (Sentinel)               │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          业务服务层 (Service Layer)                          │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌───────────┐ │
│  │ 用户服务   │ │ 视频服务   │ │ 学习服务   │ │ AI服务     │ │ 微信服务  │ │
│  │ user-svc   │ │ video-svc  │ │ study-svc  │ │ ai-svc     │ │ wechat-svc│ │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └───────────┘ │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐               │
│  │ 资源服务   │ │ 运营服务   │ │ 支付服务   │ │ 消息服务   │               │
│  │ resource   │ │ operation  │ │ payment    │ │ message    │               │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘               │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据层 (Data Layer)                                 │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌───────────┐ │
│  │   MySQL    │ │   Redis    │ │ MongoDB    │ │Elasticsearch│ │   OSS     │ │
│  │  主从集群   │ │   集群     │ │  文档存储   │ │   搜索     │ │  对象存储  │ │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └───────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       第三方服务层 (External Services)                        │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐               │
│  │ 微信开放平台 │ │ OpenAI API │ │ 讯飞语音   │ │ 阿里云CDN  │               │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 架构特点

- **四层分离**：客户端、网关、业务服务、数据存储各司其职
- **微服务化**：9个核心业务服务，支持独立部署和扩展
- **多端支持**：iOS/Android/小程序/H5全平台覆盖
- **服务降级**：AI、支付等关键服务均有备用方案
- **数据分离**：关系型、缓存、文档、搜索、对象存储分工明确

---

## 二、后端微服务架构

### 2.1 技术栈选型

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 开发语言 | Java 17 + Spring Boot 3.x | 团队熟悉度高，生态成熟 |
| 微服务框架 | Spring Cloud Alibaba | Nacos注册配置、Sentinel限流 |
| 服务通信 | OpenFeign + gRPC | HTTP内部调用 + 高性能AI调用 |
| API文档 | Knife4j (Swagger) | 自动生成接口文档 |
| ORM框架 | MyBatis-Plus | 简化数据库操作 |
| 消息队列 | RocketMQ | 异步任务、事件驱动 |
| 认证授权 | Sa-Token | 轻量级权限框架 |
| 任务调度 | XXL-Job | 分布式定时任务 |

### 2.2 微服务划分

```
yxb-cloud/
├── yxb-gateway/                  # API网关服务 (端口8080)
│   ├── 统一路由
│   ├── 鉴权过滤
│   ├── 限流熔断
│   └── 日志追踪
│
├── yxb-auth/                     # 认证授权服务 (端口8082)
│   ├── Token生成/验证
│   ├── 权限管理
│   └── 登录日志
│
├── yxb-service/
│   ├── yxb-user/                 # 用户服务 (端口8081)
│   │   ├── 用户注册/登录
│   │   ├── 微信授权登录
│   │   ├── 用户信息管理
│   │   └── 会员权益管理
│   │
│   ├── yxb-video/                # 视频服务 (端口8083)
│   │   ├── 视频上传/存储
│   │   ├── 视频播放管理
│   │   ├── 字幕解析/管理
│   │   ├── 离线下载管理
│   │   ├── 音频提取
│   │   └── 视频转码
│   │
│   ├── yxb-study/                # 学习服务 (端口8084)
│   │   ├── 学习进度管理
│   │   ├── 笔记/收藏管理
│   │   ├── 单词本管理
│   │   ├── 跟读记录管理
│   │   └── 学习报告生成
│   │
│   ├── yxb-ai/                   # AI服务 (端口8086)
│   │   ├── 字幕生成（ASR）
│   │   ├── 语法讲解
│   │   ├── 发音评分
│   │   ├── 屏幕查词
│   │   ├── AI问答
│   │   └── 学习规划推荐
│   │
│   ├── yxb-wechat/               # 微信生态服务 (端口8085)
│   │   ├── 微信登录
│   │   ├── 微信支付
│   │   ├── 微信分享
│   │   ├── 扫码学习
│   │   ├── 公众号消息
│   │   └── 社群联动
│   │
│   ├── yxb-resource/             # 资源服务 (端口8087)
│   │   ├── 资源库管理
│   │   ├── 资源审核
│   │   ├── 资源推荐
│   │   └── 版权管理
│   │
│   ├── yxb-operation/            # 运营服务 (端口8088)
│   │   ├── 打卡管理
│   │   ├── 积分管理
│   │   ├── 每日推荐
│   │   └── 广告管理
│   │
│   ├── yxb-payment/              # 支付服务 (端口8089)
│   │   ├── 微信支付
│   │   ├── 订单管理
│   │   └── 发票管理
│   │
│   └── yxb-message/              # 消息服务 (端口8090)
│       ├── 站内通知
│       ├── 推送服务
│       └── 短信服务
│
├── yxb-common/                   # 公共模块
│   ├── yxb-common-core           # 核心工具类
│   │   ├── Result统一响应
│   │   ├── BizException异常
│   │   ├── 常量定义
│   │   └── 工具类
│   │
│   ├── yxb-common-redis          # Redis封装
│   │   ├── RedisTemplate配置
│   │   ├── 缓存注解
│   │   └── 分布式锁
│   │
│   ├── yxb-common-mybatis        # MyBatis-Plus配置
│   │   ├── 分页插件
│   │   ├── 字段自动填充
│   │   └── 逻辑删除
│   │
│   ├── yxb-common-security       # 安全模块
│   │   ├── Sa-Token配置
│   │   ├── 权限注解
│   │   └── 加密工具
│   │
│   └── yxb-common-swagger        # 文档模块
│       └── Knife4j配置
│
└── yxb-job/                      # 定时任务服务
    ├── 学习报告定时生成
    ├── 积分过期处理
    └── 资源推荐计算
```

### 2.3 服务间调用关系

```
                 ┌─────────────┐
                 │   Gateway   │
                 └──────┬──────┘
                        │
     ┌──────────────────┼──────────────────┐
     │                  │                  │
     ▼                  ▼                  ▼
┌─────────┐       ┌──────────┐       ┌──────────┐
│  Auth   │◄──────│   User   │──────►│  Wechat  │
└─────────┘       └──────────┘       └──────────┘
                        │
     ┌──────────────────┼──────────────────┐
     │                  │                  │
     ▼                  ▼                  ▼
┌─────────┐       ┌──────────┐       ┌──────────┐
│  Video  │◄──────│  Study   │──────►│    AI    │
└─────────┘       └──────────┘       └──────────┘
     │                  │                  │
     ▼                  ▼                  ▼
┌─────────┐       ┌──────────┐       ┌──────────┐
│Resource │       │Operation │       │ Message  │
└─────────┘       └──────────┘       └──────────┘
```

### 2.4 核心服务接口设计示例

#### 2.4.1 视频服务接口

```java
@RestController
@RequestMapping("/api/video")
@Api(tags = "视频管理")
public class VideoController {
    
    /**
     * 上传视频
     */
    @PostMapping("/upload")
    @ApiOperation("上传视频")
    public Result<VideoUploadResult> upload(
        @RequestParam("file") MultipartFile file,
        @RequestParam("title") String title,
        @RequestParam("language") String language
    ) {
        // 1. 上传到OSS
        // 2. 创建转码任务
        // 3. 返回videoId
    }
    
    /**
     * 获取视频详情
     */
    @GetMapping("/{id}")
    @ApiOperation("获取视频详情")
    public Result<VideoDetailVO> getDetail(@PathVariable Long id) {
        // 返回视频信息 + 字幕列表
    }
    
    /**
     * 生成字幕（AI）
     */
    @PostMapping("/{id}/generate-subtitle")
    @ApiOperation("AI生成字幕")
    public Result<String> generateSubtitle(
        @PathVariable Long id,
        @RequestParam("language") String language
    ) {
        // 异步生成，返回taskId
    }
}
```

#### 2.4.2 学习服务接口

```java
@RestController
@RequestMapping("/api/study")
@Api(tags = "学习管理")
public class StudyController {
    
    /**
     * 保存学习进度
     */
    @PostMapping("/progress")
    @ApiOperation("保存学习进度")
    public Result<Void> saveProgress(@RequestBody ProgressSaveDTO dto) {
        // videoId, position, duration
    }
    
    /**
     * 添加笔记
     */
    @PostMapping("/note")
    @ApiOperation("添加笔记")
    public Result<NoteVO> addNote(@RequestBody NoteAddDTO dto) {
        // videoId, timestamp, content, screenshot
    }
    
    /**
     * 添加到单词本
     */
    @PostMapping("/vocabulary")
    @ApiOperation("添加单词")
    public Result<VocabularyVO> addWord(@RequestBody WordAddDTO dto) {
        // word, definition, videoId, timestamp
    }
    
    /**
     * 获取学习报告
     */
    @GetMapping("/report")
    @ApiOperation("学习报告")
    public Result<StudyReportVO> getReport(
        @RequestParam("startDate") String startDate,
        @RequestParam("endDate") String endDate
    ) {
        // 统计学习时长、视频数、单词数等
    }
}
```

#### 2.4.3 AI服务接口

```java
@RestController
@RequestMapping("/api/ai")
@Api(tags = "AI辅助")
public class AIController {
    
    /**
     * 语法讲解
     */
    @PostMapping("/grammar/explain")
    @ApiOperation("语法讲解")
    public Result<GrammarExplanationVO> explainGrammar(
        @RequestBody GrammarExplainDTO dto
    ) {
        // sentence, language -> 语法点分析
    }
    
    /**
     * 发音评分
     */
    @PostMapping("/pronunciation/score")
    @ApiOperation("发音评分")
    public Result<PronunciationScoreVO> scorePronunciation(
        @RequestParam("audio") MultipartFile audio,
        @RequestParam("referenceText") String referenceText,
        @RequestParam("language") String language
    ) {
        // 返回总分、单词级评分、建议
    }
    
    /**
     * 单词释义
     */
    @GetMapping("/word/define")
    @ApiOperation("单词释义")
    public Result<WordDefinitionVO> defineWord(
        @RequestParam("word") String word,
        @RequestParam("language") String language
    ) {
        // 返回音标、释义、例句、词源
    }
    
    /**
     * AI问答
     */
    @PostMapping("/chat")
    @ApiOperation("AI问答")
    public Result<ChatResponseVO> chat(@RequestBody ChatRequestDTO dto) {
        // 流式返回（SSE）
    }
}
```

---

## 三、数据存储架构

### 3.1 数据库选型

| 存储类型 | 技术选型 | 用途 |
|---------|---------|------|
| 关系型数据库 | MySQL 8.0 (主从) | 用户、订单、学习记录等核心业务数据 |
| 缓存 | Redis Cluster | 会话、热点数据、排行榜、分布式锁 |
| 文档数据库 | MongoDB | 笔记内容、AI问答记录、日志 |
| 搜索引擎 | Elasticsearch | 资源搜索、字幕全文检索 |
| 对象存储 | 阿里云OSS | 视频文件、音频文件、图片 |
| CDN | 阿里云CDN | 视频加速分发 |

### 3.2 MySQL 分库设计

```
yxb_user        # 用户库
├── yxb_user                # 用户基本信息
├── yxb_user_wechat         # 微信绑定
└── yxb_user_vip            # VIP信息
 
yxb_video       # 视频库
├── yxb_video               # 视频信息
├── yxb_subtitle            # 字幕信息
├── yxb_subtitle_content    # 字幕内容
└── yxb_video_download      # 下载记录
 
yxb_study       # 学习库
├── yxb_learning_record     # 学习进度
├── yxb_note                # 笔记
├── yxb_vocabulary          # 单词本
├── yxb_vocabulary_review   # 复习记录
└── yxb_follow_reading      # 跟读记录
 
yxb_ai          # AI数据库
├── yxb_grammar_explanation # 语法讲解缓存
├── yxb_ai_question         # AI问答记录
└── yxb_asr_task            # ASR任务记录
 
yxb_resource    # 资源库
├── yxb_resource_category   # 资源分类
├── yxb_online_resource     # 在线资源
└── yxb_resource_review     # 资源评价
 
yxb_operation   # 运营库
├── yxb_checkin             # 打卡记录
├── yxb_points              # 积分记录
├── yxb_daily_recommendation# 每日推荐
└── yxb_system_config       # 系统配置
 
yxb_wechat      # 微信库
├── yxb_wechat_share        # 分享记录
├── yxb_study_group         # 学习社群
├── yxb_study_group_member  # 社群成员
├── yxb_study_task          # 学习任务
└── yxb_task_completion     # 任务完成记录
 
yxb_payment     # 支付库
├── wechat_pay_order        # 支付订单
├── payment_record          # 支付记录
└── invoice_info            # 发票信息
```

### 3.3 Redis 缓存策略

```
Redis Key 设计：
├── user:token:{userId}           # 用户Token (TTL: 7d)
├── user:info:{userId}            # 用户信息缓存 (TTL: 1h)
├── video:hot:list                # 热门视频列表 (TTL: 10min)
├── video:detail:{videoId}        # 视频详情 (TTL: 30min)
├── video:subtitle:{videoId}      # 字幕缓存 (TTL: 1d)
├── study:progress:{userId}:{videoId}  # 播放进度 (TTL: 30d)
├── ai:grammar:{sentenceHash}     # 语法讲解缓存 (TTL: 7d)
├── ai:word:{word}:{lang}         # 单词释义缓存 (TTL: 30d)
├── rank:checkin:daily            # 每日打卡排行 (TTL: 1d)
├── rank:study:weekly             # 周学习时长排行 (TTL: 1w)
├── lock:{resource}               # 分布式锁 (TTL: 30s)
└── mq:idempotent:{msgId}         # 消息幂等 (TTL: 24h)
```

### 3.4 MongoDB 文档设计

```javascript
// 笔记集合
db.notes.insertOne({
    _id: ObjectId(),
    userId: 10001,
    videoId: 20001,
    timestamp: 125.5,  // 视频时间点（秒）
    content: "这句话的语法是...",
    screenshot: "https://oss.xxx.com/note/xxx.jpg",
    tags: ["语法", "过去完成时"],
    createdAt: ISODate("2025-12-22T12:00:00Z")
})

// AI问答记录集合
db.ai_chat.insertOne({
    _id: ObjectId(),
    userId: 10001,
    sessionId: "sess_xxx",
    messages: [
        {
            role: "user",
            content: "什么是过去完成时?",
            timestamp: ISODate()
        },
        {
            role: "assistant",
            content: "过去完成时表示...",
            timestamp: ISODate()
        }
    ],
    createdAt: ISODate()
})
```

### 3.5 Elasticsearch 索引设计

```json
// 资源索引
PUT /yxb_resources
{
  "mappings": {
    "properties": {
      "resourceId": {"type": "long"},
      "title": {
        "type": "text",
        "analyzer": "ik_max_word",
        "search_analyzer": "ik_smart"
      },
      "description": {"type": "text", "analyzer": "ik_max_word"},
      "tags": {"type": "keyword"},
      "language": {"type": "keyword"},
      "difficulty": {"type": "keyword"},
      "category": {"type": "keyword"},
      "viewCount": {"type": "long"},
      "rating": {"type": "float"},
      "createdAt": {"type": "date"}
    }
  }
}

// 字幕全文检索索引
PUT /yxb_subtitles
{
  "mappings": {
    "properties": {
      "videoId": {"type": "long"},
      "language": {"type": "keyword"},
      "segments": {
        "type": "nested",
        "properties": {
          "startTime": {"type": "double"},
          "endTime": {"type": "double"},
          "content": {"type": "text", "analyzer": "standard"},
          "translation": {"type": "text", "analyzer": "ik_max_word"}
        }
      }
    }
  }
}
```

---

## 四、移动端架构

### 4.1 iOS架构 (Swift + SwiftUI)

```
YXBApp/
├── App/
│   ├── YXBApp.swift           # 应用入口
│   └── AppDelegate.swift
│
├── Core/
│   ├── Network/               # 网络层
│   │   ├── APIClient.swift    # Alamofire封装
│   │   ├── APIEndpoint.swift  # 接口定义
│   │   └── APIError.swift
│   │
│   ├── Database/              # 本地数据库
│   │   ├── RealmManager.swift
│   │   └── Models/
│   │
│   ├── Player/                # 视频播放器
│   │   ├── VideoPlayer.swift  # AVPlayer封装
│   │   ├── SubtitleManager.swift
│   │   ├── LoopController.swift
│   │   └── SpeedController.swift
│   │
│   └── Audio/                 # 音频录制
│       ├── AudioRecorder.swift
│       └── AudioProcessor.swift
│
├── Features/
│   ├── Auth/                  # 登录注册
│   │   ├── Views/
│   │   ├── ViewModels/
│   │   └── Models/
│   │
│   ├── Home/                  # 首页
│   ├── Player/                # 播放页
│   │   ├── PlayerView.swift
│   │   ├── SubtitleView.swift
│   │   ├── ControlPanel.swift
│   │   └── AIAssistPanel.swift
│   │
│   ├── Study/                 # 学习管理
│   │   ├── NoteView.swift
│   │   ├── WordBookView.swift
│   │   └── ReportView.swift
│   │
│   └── Profile/               # 个人中心
│
├── Shared/
│   ├── UI/                    # 公共UI组件
│   ├── Utils/                 # 工具类
│   └── Extensions/            # 扩展
│
└── Resources/
    ├── Assets.xcassets
    └── Localizable.strings
```

**技术栈：**
- 架构：MVVM + Clean Architecture
- UI：SwiftUI + UIKit混合
- 网络：Alamofire + Moya
- 响应式：Combine
- 本地存储：Realm
- 视频播放：AVPlayer
- 语音：AVAudioEngine + 讯飞SDK

### 4.2 Android架构 (Kotlin + Jetpack Compose)

```
com.yxb.app/
├── YXBApplication.kt
│
├── core/
│   ├── network/               # 网络层
│   │   ├── ApiService.kt      # Retrofit接口
│   │   ├── NetworkModule.kt   # Hilt模块
│   │   └── ResultWrapper.kt
│   │
│   ├── database/              # 本地数据库
│   │   ├── YXBDatabase.kt     # Room
│   │   └── dao/
│   │
│   ├── player/                # 视频播放器
│   │   ├── VideoPlayer.kt     # ExoPlayer封装
│   │   ├── SubtitleParser.kt
│   │   └── LoopController.kt
│   │
│   └── audio/                 # 音频录制
│       ├── AudioRecorder.kt
│       └── AudioProcessor.kt
│
├── feature/
│   ├── auth/                  # 登录注册
│   │   ├── ui/
│   │   ├── viewmodel/
│   │   └── data/
│   │
│   ├── home/                  # 首页
│   ├── player/                # 播放页
│   │   ├── PlayerScreen.kt
│   │   ├── SubtitleView.kt
│   │   └── AIAssistPanel.kt
│   │
│   ├── study/                 # 学习管理
│   └── profile/               # 个人中心
│
└── shared/
    ├── ui/                    # 公共UI组件
    ├── util/                  # 工具类
    └── model/                 # 数据模型
```

**技术栈：**
- 架构：MVVM + Clean Architecture
- UI：Jetpack Compose
- 依赖注入：Hilt
- 网络：Retrofit + OkHttp
- 响应式：Kotlin Coroutines + Flow
- 本地存储：Room + DataStore
- 视频播放：ExoPlayer

---

## 五、前端架构（微信生态）

### 5.1 微信小程序架构

```
yxb-miniprogram/
├── pages/
│   ├── index/                 # 首页
│   │   ├── index.wxml
│   │   ├── index.js
│   │   └── index.wxss
│   │
│   ├── player/                # 播放页
│   │   ├── player.wxml
│   │   ├── player.js          # 播放逻辑
│   │   └── components/
│   │       ├── subtitle-view/ # 字幕组件
│   │       └── control-panel/ # 控制面板
│   │
│   ├── study/                 # 学习管理
│   │   ├── note/              # 笔记
│   │   ├── wordbook/          # 单词本
│   │   └── report/            # 学习报告
│   │
│   ├── resource/              # 资源库
│   └── profile/               # 个人中心
│
├── components/                # 全局组件
│   ├── video-player/          # 视频播放组件
│   ├── word-card/             # 单词卡片
│   └── ai-chat/               # AI对话组件
│
├── services/                  # 服务层
│   ├── api.js                 # API封装
│   ├── auth.js                # 登录授权
│   ├── storage.js             # 本地存储
│   └── wechat.js              # 微信API封装
│
├── store/                     # 状态管理(MobX)
│   ├── user.js
│   ├── player.js
│   └── study.js
│
├── utils/
│   ├── request.js             # 请求封装
│   ├── subtitle.js            # 字幕解析
│   └── format.js              # 格式化工具
│
├── app.js
├── app.json
└── project.config.json
```

**技术栈：**
- 框架：原生MINA框架
- 状态管理：MobX-miniprogram
- UI组件：Vant Weapp
- 请求封装：Promise化wx.request

### 5.2 微信公众号H5架构

```
yxb-h5/
├── src/
│   ├── views/
│   │   ├── Home.vue           # 首页
│   │   ├── Article.vue        # 文章详情
│   │   ├── AIChat.vue         # AI问答
│   │   ├── SharePage.vue      # 分享落地页
│   │   └── WordQuery.vue      # 单词查询
│   │
│   ├── components/
│   │   ├── ChatPanel.vue      # 聊天面板
│   │   ├── ResourceCard.vue   # 资源卡片
│   │   └── WordCard.vue       # 单词卡片
│   │
│   ├── api/
│   │   ├── index.ts
│   │   ├── user.ts
│   │   └── ai.ts
│   │
│   ├── store/                 # Pinia
│   │   ├── user.ts
│   │   └── chat.ts
│   │
│   ├── router/
│   │   └── index.ts
│   │
│   ├── utils/
│   │   ├── request.ts
│   │   ├── wechat-jssdk.ts    # JSSDK封装
│   │   └── auth.ts
│   │
│   ├── App.vue
│   └── main.ts
│
├── vite.config.ts
├── package.json
└── tsconfig.json
```

**技术栈：**
- 框架：Vue 3 + Vite
- 状态管理：Pinia
- UI组件：Vant 4
- TypeScript
- 微信能力：JSSDK

---

## 六、AI服务集成架构

### 6.1 AI服务降级策略

```
┌─────────────────────────────────────────────────────────┐
│                    AI Gateway Layer                      │
│                   (统一接入 + 路由)                       │
└─────────────────────────┬───────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│   Primary     │ │   Secondary   │ │   Fallback    │
│   服务商A     │ │   服务商B      │ │   服务商C     │
└───────────────┘ └───────────────┘ └───────────────┘
```

**降级配置：**

```yaml
ai:
  services:
    # 字幕生成 (ASR)
    asr:
      primary: xunfei      # 讯飞语音
      secondary: aliyun    # 阿里云ASR
      fallback: baidu      # 百度语音
      timeout: 30000       # 30秒超时
    
    # 语法讲解 / AI问答
    llm:
      primary: openai      # OpenAI GPT-4
      secondary: claude    # Claude API
      fallback: wenxin     # 文心一言
      timeout: 15000
    
    # 发音评分
    pronunciation:
      primary: xunfei      # 讯飞口语评测
      secondary: aliyun    # 阿里云智能语音
      timeout: 10000
    
    # 单词翻译
    translation:
      primary: youdao      # 有道词典
      secondary: baidu     # 百度翻译
      timeout: 5000
```

### 6.2 AI服务调用实现

```java
@Service
public class AIServiceRouter {
    
    @Resource
    private Map<String, AIProvider> providers;
    
    /**
     * 带降级的AI调用
     */
    public <T> T callWithFallback(
        AIServiceType type,
        AIRequest request,
        Class<T> responseClass
    ) {
        // 获取该类型的服务商列表（按优先级）
        List<AIProvider> providerList = getProviders(type);
        
        Exception lastException = null;
        
        // 依次尝试
        for (AIProvider provider : providerList) {
            try {
                log.info("Calling AI provider: {}", provider.getName());
                
                T response = provider.call(request, responseClass);
                
                if (response != null) {
                    // 成功，缓存结果
                    cacheResult(request, response);
                    
                    // 记录成功调用
                    metricsService.recordSuccess(provider.getName(), type);
                    
                    return response;
                }
            } catch (Exception e) {
                log.warn("Provider {} failed: {}", provider.getName(), e.getMessage());
                lastException = e;
                
                // 记录失败
                metricsService.recordFailure(provider.getName(), type);
                
                // 继续下一个
                continue;
            }
        }
        
        // 所有服务商都失败
        throw new AIServiceException("All AI providers failed", lastException);
    }
    
    /**
     * 缓存策略
     */
    private void cacheResult(AIRequest request, Object response) {
        String cacheKey = generateCacheKey(request);
        long ttl = getCacheTTL(request.getType());
        
        redisTemplate.opsForValue().set(cacheKey, response, ttl, TimeUnit.SECONDS);
    }
}
```

### 6.3 AI成本优化策略

```java
@Service
public class AICostOptimizer {
    
    /**
     * 智能路由：简单问题用便宜模型
     */
    public AIProvider selectOptimalProvider(String question) {
        // 1. 分析问题复杂度
        int complexity = analyzeComplexity(question);
        
        if (complexity < 3) {
            // 简单问题 -> GPT-3.5 (便宜10倍)
            return gpt35Provider;
        } else if (complexity < 7) {
            // 中等问题 -> Claude
            return claudeProvider;
        } else {
            // 复杂问题 -> GPT-4
            return gpt4Provider;
        }
    }
    
    /**
     * 批量处理：减少请求次数
     */
    public List<GrammarExplanation> batchExplain(List<String> sentences) {
        // 1个请求处理10个句子，成本降低50%
        String prompt = buildBatchPrompt(sentences);
        
        String response = openAIService.complete(prompt);
        
        return parseBatchResponse(response);
    }
    
    /**
     * 用户限流：控制免费用户使用
     */
    public void checkRateLimit(Long userId, AIServiceType type) {
        String key = String.format("ai:limit:%s:%d", type, userId);
        
        Long count = redisTemplate.opsForValue().increment(key);
        
        if (count == 1) {
            // 设置过期时间（每天重置）
            redisTemplate.expire(key, 1, TimeUnit.DAYS);
        }
        
        UserVIP vip = userService.getVIP(userId);
        int limit = vip.isVip() ? Integer.MAX_VALUE : 10;
        
        if (count > limit) {
            throw new BizException("今日免费额度已用完，请升级VIP");
        }
    }
}
```

---

## 七、微信生态集成架构

### 7.1 统一登录态管理

```
用户登录流程：
┌───────┐      ┌───────┐      ┌───────┐      ┌───────┐
│ 客户端 │ ──► │ 微信  │ ──► │ 后端  │ ──► │ Redis │
└───────┘      └───────┘      └───────┘      └───────┘
    │              │              │              │
    │  1.wx.login  │              │              │
    │─────────────►│              │              │
    │              │              │              │
    │  2.返回code  │              │              │
    │◄─────────────│              │              │
    │              │              │              │
    │  3.code换token               │              │
    │─────────────────────────────►│              │
    │              │  4.code2Session              │
    │              │  获取openid/unionid          │
    │              │◄─────────────►│              │
    │              │              │  5.生成JWT   │
    │              │              │  保存session │
    │              │              │─────────────►│
    │  6.返回token │              │              │
    │◄─────────────────────────────│              │
```

**实现代码：**

```java
@Service
public class WechatAuthService {
    
    /**
     * 小程序登录
     */
    public LoginResult miniappLogin(String code) {
        // 1. code2Session
        WxMaJscode2SessionResult session = wxMaService.getUserService()
            .getSessionInfo(code);
        
        String openid = session.getOpenid();
        String unionid = session.getUnionid();
        
        // 2. 查询或创建用户
        User user = userService.getOrCreateByWechat(openid, unionid);
        
        // 3. 生成JWT Token
        String token = saTokenService.createToken(user.getId());
        
        // 4. 保存Session
        redisTemplate.opsForValue().set(
            "user:token:" + user.getId(),
            token,
            7, TimeUnit.DAYS
        );
        
        // 5. 返回结果
        return LoginResult.builder()
            .token(token)
            .userId(user.getId())
            .nickname(user.getNickname())
            .avatar(user.getAvatar())
            .build();
    }
    
    /**
     * 获取手机号
     */
    public String getPhoneNumber(String code) {
        WxMaPhoneNumberInfo phoneInfo = wxMaService.getUserService()
            .getPhoneNoInfo(code);
        
        return phoneInfo.getPhoneNumber();
    }
}
```

### 7.2 微信分享配置

```javascript
// 小程序分享
Page({
    // 自定义转发
    onShareAppMessage() {
        const {videoId, title, cover} = this.data.video
        
        return {
            title: `我正在学《${title}》，快来一起学吧！`,
            path: `/pages/player/player?videoId=${videoId}&from=share&userId=${this.userId}`,
            imageUrl: cover,
            
            success: (res) => {
                // 分享成功奖励积分
                this.api.addPoints({
                    type: 'share',
                    videoId: videoId,
                    points: 10
                })
            }
        }
    },
    
    // 分享到朋友圈
    onShareTimeline() {
        return {
            title: this.data.video.title,
            query: `videoId=${this.data.video.id}&from=timeline`,
            imageUrl: this.data.video.cover
        }
    }
})
```

---

## 八、部署与运维架构

### 8.1 Kubernetes部署架构

```yaml
# Namespace隔离
apiVersion: v1
kind: Namespace
metadata:
  name: yxb-prod
---
# Deployment示例
apiVersion: apps/v1
kind: Deployment
metadata:
  name: yxb-gateway
  namespace: yxb-prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: yxb-gateway
  template:
    metadata:
      labels:
        app: yxb-gateway
    spec:
      containers:
      - name: yxb-gateway
        image: registry.cn-hangzhou.aliyuncs.com/yxb/gateway:1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: NACOS_ADDR
          value: "nacos-service:8848"
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        resources:
          requests:
            cpu: "500m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "1Gi"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 20
          periodSeconds: 5
---
# Service
apiVersion: v1
kind: Service
metadata:
  name: yxb-gateway-service
  namespace: yxb-prod
spec:
  selector:
    app: yxb-gateway
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  type: ClusterIP
---
# Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: yxb-ingress
  namespace: yxb-prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: api.yxb.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: yxb-gateway-service
            port:
              number: 8080
```

### 8.2 CI/CD流程

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        HARBOR_REGISTRY = 'registry.cn-hangzhou.aliyuncs.com'
        HARBOR_NAMESPACE = 'yxb'
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/xxx/yxb-backend.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh 'mvn sonar:sonar'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    def services = ['gateway', 'user', 'video', 'ai']
                    services.each { service ->
                        sh """
                            docker build -t ${HARBOR_REGISTRY}/${HARBOR_NAMESPACE}/${service}:${IMAGE_TAG} \
                                -f yxb-${service}/Dockerfile .
                        """
                    }
                }
            }
        }
        
        stage('Push to Harbor') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'harbor-credentials', 
                    usernameVariable: 'HARBOR_USER', passwordVariable: 'HARBOR_PASS')]) {
                    sh """
                        echo ${HARBOR_PASS} | docker login ${HARBOR_REGISTRY} -u ${HARBOR_USER} --password-stdin
                        docker push ${HARBOR_REGISTRY}/${HARBOR_NAMESPACE}/gateway:${IMAGE_TAG}
                        docker push ${HARBOR_REGISTRY}/${HARBOR_NAMESPACE}/user:${IMAGE_TAG}
                        docker push ${HARBOR_REGISTRY}/${HARBOR_NAMESPACE}/video:${IMAGE_TAG}
                        docker push ${HARBOR_REGISTRY}/${HARBOR_NAMESPACE}/ai:${IMAGE_TAG}
                    """
                }
            }
        }
        
        stage('Deploy to K8s') {
            steps {
                sh """
                    kubectl set image deployment/yxb-gateway yxb-gateway=${HARBOR_REGISTRY}/${HARBOR_NAMESPACE}/gateway:${IMAGE_TAG} -n yxb-prod
                    kubectl rollout status deployment/yxb-gateway -n yxb-prod
                """
            }
        }
    }
    
    post {
        success {
            dingtalk (
                robot: 'Jenkins-Bot',
                type: 'MARKDOWN',
                title: '发布成功',
                text: ["### 鹦学伴发布成功\n",
                       "- 环境: 生产环境\n",
                       "- 版本: ${IMAGE_TAG}\n",
                       "- 时间: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"]
            )
        }
        failure {
            dingtalk (
                robot: 'Jenkins-Bot',
                type: 'MARKDOWN',
                title: '发布失败',
                text: ["### 鹦学伴发布失败\n",
                       "- 环境: 生产环境\n",
                       "- 版本: ${IMAGE_TAG}\n",
                       "- 请及时处理！"]
            )
        }
    }
}
```

### 8.3 监控告警体系

```
┌─────────────────────────────────────────────────────────┐
│                    监控体系                              │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │ Prometheus  │  │  Grafana    │  │  AlertManager   │  │
│  │  指标采集   │  │  可视化     │  │  告警通知        │  │
│  └─────────────┘  └─────────────┘  └─────────────────┘  │
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │    ELK      │  │  SkyWalking │  │  Sentry         │  │
│  │  日志分析   │  │  链路追踪   │  │  错误追踪        │  │
│  └─────────────┘  └─────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**监控指标：**
- **系统指标**：CPU、内存、磁盘、网络
- **JVM指标**：堆内存、GC次数、线程数
- **接口指标**：QPS、响应时间、错误率
- **业务指标**：DAU、视频播放量、AI调用次数、收入

**告警规则：**
```yaml
groups:
- name: yxb-alerts
  rules:
  # 接口错误率告警
  - alert: HighErrorRate
    expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.01
    for: 2m
    annotations:
      summary: "接口错误率过高"
      description: "错误率: {{ $value | humanizePercentage }}"
  
  # AI服务成本告警
  - alert: HighAICost
    expr: sum(ai_cost_total) > 1000
    for: 1h
    annotations:
      summary: "AI服务费用过高"
      description: "当前小时费用: ¥{{ $value }}"
  
  # 数据库连接池告警
  - alert: DatabaseConnectionPoolLow
    expr: hikaricp_connections_active / hikaricp_connections_max > 0.8
    for: 5m
    annotations:
      summary: "数据库连接池不足"
```

---

## 九、技术选型汇总

| 领域 | 技术选型 | 备注 |
|------|---------|------|
| **后端框架** | Spring Boot 3.x + Spring Cloud Alibaba | 微服务架构 |
| **服务注册** | Nacos | 配置+注册中心 |
| **API网关** | Spring Cloud Gateway | 路由+鉴权+限流 |
| **数据库** | MySQL 8.0 主从 | 分库设计 |
| **缓存** | Redis Cluster | 高可用集群 |
| **消息队列** | RocketMQ | 异步处理 |
| **搜索引擎** | Elasticsearch 8.x | 全文检索 |
| **对象存储** | 阿里云OSS | 视频文件存储 |
| **CDN** | 阿里云CDN | 视频加速 |
| **iOS** | Swift + SwiftUI + AVPlayer | 原生开发 |
| **Android** | Kotlin + Compose + ExoPlayer | 原生开发 |
| **小程序** | 原生MINA + Vant Weapp | 微信小程序 |
| **H5** | Vue3 + Vite + Vant | 公众号H5 |
| **容器化** | Docker + Kubernetes | 云原生部署 |
| **CI/CD** | Jenkins + Harbor | 自动化发布 |
| **监控** | Prometheus + Grafana + ELK | 全链路监控 |
| **AI服务** | OpenAI + 讯飞 + 阿里云 | 多服务商降级 |

---

## 十、总结

本技术架构设计方案涵盖：

1. **整体架构**：四层架构（客户端→网关→服务→数据）
2. **后端微服务**：9个核心服务，职责清晰
3. **数据存储**：MySQL分库 + Redis + MongoDB + ES + OSS
4. **移动端**：iOS/Android原生，MVVM架构
5. **前端**：小程序 + H5，微信生态深度集成
6. **AI集成**：多服务商降级，成本优化
7. **部署运维**：K8s容器化，CI/CD自动化，全链路监控

**核心优势：**
- ✅ 架构清晰，易于扩展
- ✅ 技术选型成熟，降低风险
- ✅ 服务降级完善，保障稳定性
- ✅ 成本优化策略，可持续运营

**下一步工作：**
1. 详细接口文档编写
2. 数据库表结构优化
3. 核心模块原型开发
4. 性能压测与优化

---

**本文档为"鹦学伴"项目技术架构设计方案，供开发团队参考。**
